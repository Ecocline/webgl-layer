<!-- An Example of Searches from the Drawing Manager API with multiple distances reflected by different colouring -->

<html>
<head>
  <title>Drawing Manager Sample</title>
  <style>
      html, body, #map-div {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: 'Roboto', sans-serif;
      }

      #panel {
        position: absolute;
        top: 20px;
        left: 110px;
        background: white;
        padding: 0 20px 10px 20px;
        border: 1px solid black;
        min-width: 115px;
      }

      #panel div{
        margin: 10px 0px
      }

      button{
        float: right;
        margin: 0 5px;        
      }
    </style>

    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

    <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?libraries=places,drawing"></script>

    <!-- WebGL Layer -->
    <script src="../CanvasLayer.js"></script>
    <script src="../ShaderProgram.js"></script>
    <script src="../libtess.cat.js"></script>
    <script src="../WebGLLayer.js"></script>

    <!-- Using a JSTS Index for Spatial Queries -->
    <script src="https://rawgit.com/bjornharrtell/jsts/master/lib/javascript.util.js"></script>
    <script src="https://rawgit.com/bjornharrtell/jsts/master/lib/jsts.js"></script>

    <script>
      var map;
      var dataLayer;
      var accessToken;

      var index = new jsts.index.strtree.STRtree();

      var defaultColor = [1.0, 0., 0.];
      var highlightColors = [[0., 0., 1.0], [0., 0.5, 0.5], [0., 1.0, 0.]];

      function init(){
        var mapOptions = {
          zoom: 12,
          center: new google.maps.LatLng(51.50711, -0.123124),
          mapTypeId: google.maps.MapTypeId.ROADMAP,
        };

        var mapDiv = document.getElementById('map-div');
        map = new google.maps.Map(mapDiv, mapOptions);


        var drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.POLYLINE,
          drawingControl: true,
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: [
              google.maps.drawing.OverlayType.POLYLINE
            ]
          }
        });
        drawingManager.setMap(map);

        google.maps.event.addListener(drawingManager, 'overlaycomplete', overlaySearch);

        dataLayer = new WebGLLayer(map);
        dataLayer.tilebase = 'http://130.211.58.85:8080/postcodes/';
        dataLayer.zoomlock = 12;

        //Overwrite onAddFeature to add features to index
        var reader = new jsts.io.GeoJSONReader();
        dataLayer.onAddFeature = function(feature){
          var feat = reader.read(feature);
          //Try inserting the point into the index. Won't work if the index has already been built.
          try{
            index.insert(feat.geometry.getEnvelopeInternal(), feat);
          }catch(e){
            
          }
        }

        dataLayer.start();
      }
      document.addEventListener('DOMContentLoaded', init, false);
      

      var overlaySearch = function(event){
        var geometryFactory = new jsts.geom.GeometryFactory();
        var reader = new jsts.io.WKTReader(geometryFactory);
        var overlay = event.overlay;
        var wkt = overlayToWKT(overlay, event.type);
        console.log(wkt);
        var geom = reader.read(wkt);
        var buffer = geom.buffer(0.024); 
        var env = buffer.computeEnvelopeInternal();
        var search = buffer;
        var result = index.query(env);
        for(var i = 0; i < result.length; i++){
          var res = result[i].geometry;
          if(search.intersects(res)){
            switch(res.getGeometryType()){
              case 'Point':
                var dist = jsts.operation.distance.DistanceOp.distance(res, geom);
                var idx = result[i].properties.index;

                var factor = Math.floor(dist/0.008);
                var color = highlightColors[factor];

                dataLayer.changePointColor(idx, color);
                break;
              case 'Polygon':
                var idxStart = result[i].properties.indexStart;
                var idxEnd = result[i].properties.indexEnd;
                dataLayer.changePolyColor(idxStart, idxEnd, highlightColor);
            }
          }
        }
      }

      var overlayToWKT = function(overlay, type){
        var path = overlay.getPath();
        console.log(overlay);
        switch(type){
          case google.maps.drawing.OverlayType.POLYGON:
            var wkt = 'POLYGON((' + path.getAt(0).lng() + ' ' + path.getAt(0).lat();
            for(var i = 1; i < path.getLength(); i++){
              var latlng = path.getAt(i);
              wkt = wkt + ', ' + latlng.lng() + ' ' + latlng.lat();
            }
            wkt = wkt + ', ' + path.getAt(0).lng() + ' ' + path.getAt(0).lat() + '))';
            return wkt;
          case google.maps.drawing.OverlayType.POLYLINE:
            var wkt = 'LINESTRING( ' + path.getAt(0).lng() + ' ' + path.getAt(0).lat();
              for(var i = 1; i < path.getLength(); i++){
                var latlng = path.getAt(i);
                wkt = wkt + ', ' + latlng.lng() + ' ' + latlng.lat();
              }
            wkt = wkt + ')';
            return wkt;
        }
      }

      //UTILS.
      var clearColors = function(){
        for(var i = 2; i < dataLayer.features_.points.floats.length; i+= 3){
          dataLayer.features_.points.floats[i] = WebGLLayer.packColor(defaultColor);
        }
        dataLayer.features_.points.changed = true;
        dataLayer.scheduleUpdate(); 
      }

      function clearResults(){
        clearColors();
        for(var i = 0; i < markers.length; i++){
          markers[i].setMap(null);
        }

        markers = [];
      }

      //DOM Manipulation for Input Fields
      function runSearch(){
        placesSearch(document.querySelector('#search-query').value, document.querySelector('#radius').value);
      }

      function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : null;
      }

      function defaultUpdate(value){
        var rgb = hexToRgb(value);
        defaultColor = [rgb.r/255, rgb.g/255, rgb.b/255];
      }

      function highlightUpdate(value){
        var rgb = hexToRgb(value);
        highlightColor = [rgb.r/255, rgb.g/255, rgb.b/255];
      }
   
    </script>
</head>
<body>
    <div id="map-div"></div>
</body>
</html>